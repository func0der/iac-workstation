---

# @todo
# - Install Firefox (if not already there)

- name: Setup Base system
  hosts: all
  tasks:
    - name: Install needed packages
      ansible.builtin.package:
        name: "{{ item ]]"
      loop:
        - apt-transport-https
        - flatpak

    - name: Enable default flatpak repository
      community.general.flatpak_remote:
        name: flathub
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
        method: user

    # @todo We can probably just add a variable somewhere and replace the hard-coded loop here.
    - name: Install flatpak software
      community.general.flatpak:
        method: user
        name: "{{ item }}"
      loop:
        - org.onlyoffice.desktopeditors
        - org.keepassxc.KeePassXC
        - com.spotify.Client
        - com.github.jeromerobert.pdfarranger

    - name: Gather the package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Install Sublime Text
      become: true
      block:
        - name: add gpg repo key
          ansible.builtin.get_url:
            url: https://download.sublimetext.com/sublimehq-pub.gpg
            dest: /etc/apt/keyrings/sublime-text.asc
            mode: '0644'

        - name: add apt repo
          ansible.builtin.apt_repository:
            repo: deb [signed-by=/etc/apt/keyrings/sublime-text.asc] https://download.sublimetext.com/ apt/stable/
            filename: sublime-text

        - name: Installing required packages
          ansible.builtin.package:
            name: sublime-text

    - name: Install protonvpn
      block:
        - name: Temporary location for installer file
          ansible.builtin.tempfile:
            suffix: protonvpn_installer
          register: protonvpn_temp_installer

        - name: Download repo installer
          ansible.builtin.get_url:
            url: https://repo.protonvpn.com/debian/dists/stable/main/binary-all/protonvpn-stable-release_1.0.3-2_all.deb
            checksum: sha256:c68a0b8dad58ab75080eed7cb989e5634fc88fca051703139c025352a6ee19ad
            dest: "{{ protonvpn_temp_installer.path }}"
            force: true # Because we have already created the temp file before

        - name: Run repo installer
          become: true
          ansible.builtin.apt:
            deb: "{{ protonvpn_temp_installer.path }}"

        - name: Install protonvpn
          become: true
          ansible.builtin.apt:
            name: protonvpn
            update_cache: true

        - name: Delete repo installer
          ansible.builtin.file:
            path: "{{ protonvpn_temp_installer.path }}"
            state: absent
          when: protonvpn_temp_installer.changed
      when: "'protonvpn' not in ansible_facts.packages"